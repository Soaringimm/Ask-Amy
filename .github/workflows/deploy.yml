name: Deploy to Production

on:
  push:
    branches:
      - main

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy Ask-Amy
    runs-on: self-hosted

    steps:
      - name: üì¶ Get commit info
        id: commit
        run: |
          cd /home/jacky/apps/Ask-Amy
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT

      - name: üöÄ Deploy to server
        run: |
          cd /home/jacky/apps/Ask-Amy
          bash deploy.sh

      - name: ‚úÖ Deployment Summary
        run: |
          echo "### üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.commit.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ steps.commit.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://localhost:8507" >> $GITHUB_STEP_SUMMARY

      - name: üß™ Health Check
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8507)
          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ Application is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Application returned HTTP $HTTP_CODE"
            exit 1
          fi
